{
  "permissions": {
    "allow": [
      "Bash(go:*)",
      "Bash(git:*)",
      "Bash(npm:*)",
      "Bash(npx:*)",
      "Bash(node:*)",
      "Bash(yarn:*)",
      "Bash(pnpm:*)",
      "Bash(mkdir:*)",
      "Bash(rm:*)",
      "Bash(cp:*)",
      "Bash(mv:*)",
      "Bash(touch:*)",
      "Bash(chmod:*)",
      "Bash(chown:*)",
      "Bash(grep:*)",
      "Bash(rg:*)",
      "Bash(find:*)",
      "Bash(sed:*)",
      "Bash(awk:*)",
      "Bash(cat:*)",
      "Bash(head:*)",
      "Bash(tail:*)",
      "Bash(wc:*)",
      "Bash(sort:*)",
      "Bash(uniq:*)",
      "Bash(ps:*)",
      "Bash(kill:*)",
      "Bash(pkill:*)",
      "Bash(lsof:*)",
      "Bash(du:*)",
      "Bash(df:*)",
      "Bash(date:*)",
      "Bash(curl:*)",
      "Bash(wget:*)",
      "Bash(tar:*)",
      "Bash(zip:*)",
      "Bash(unzip:*)",
      "Bash(echo:*)",
      "Bash(printf:*)",
      "Bash(./orchids-server:*)",
      "Bash(./orchids-api:*)",
      "Bash(tee:*)",
      "mcp__sequential-thinking__sequentialthinking",
      "Bash(staticcheck:*)",
      "Bash(deadcode:*)",
      "mcp__fetch__fetch",
      "Bash(python3 -c \"import sys,json; data=json.load\\(sys.stdin\\); text=data[0][''text'']; \nimport re\nmatches = re.findall\\(r''createServerReference\\\\\\([^\\)]+\\\\\\)'', text\\)\nfor m in matches:\n    print\\(m\\)\n    print\\(''---''\\)\n\")",
      "Bash(python3 -c \"\nimport sys, json, re\ndata = json.load\\(sys.stdin\\)\ntext = data[0][''text'']\n# Search for createServerReference with a wider pattern\nmatches = re.findall\\(r''createServerReference\\\\\\(.{20,120}?\\\\\\)'', text\\)\nfor m in matches:\n    print\\(m\\)\n    print\\(''---''\\)\n\")",
      "Bash(python3 -c \"\nimport sys, json, re\ndata = json.load\\(sys.stdin\\)\ntext = data[0][''text'']\nmatches = re.findall\\(r''createServerReference\\\\\\(.{20,120}?\\\\\\)'', text\\)\nfor m in matches:\n    print\\(m\\)\n    print\\(''---''\\)\n\")",
      "Bash(redis-cli --raw GET \"orchids:accounts:id:53\")",
      "Bash(python3 << 'PYEOF'\nimport json, subprocess\n\nr53 = subprocess.run\\(['redis-cli', '--raw', 'GET', 'orchids:accounts:id:53'], capture_output=True, text=True\\)\nr54 = subprocess.run\\(['redis-cli', '--raw', 'GET', 'orchids:accounts:id:54'], capture_output=True, text=True\\)\nd53 = json.loads\\(r53.stdout.strip\\(\\)\\)\nd54 = json.loads\\(r54.stdout.strip\\(\\)\\)\n\nall_keys = sorted\\(set\\(list\\(d53.keys\\(\\)\\) + list\\(d54.keys\\(\\)\\)\\)\\)\nsensitive = {'token', 'client_cookie', 'session_cookie', 'refresh_token'}\n\nfmt = \"{:<22} {:<45} {:<45} {}\"\nprint\\(fmt.format\\(\"Field\", \"Account 53\", \"Account 54\", \"Match\"\\)\\)\nprint\\(\"-\" * 162\\)\nfor k in all_keys:\n    v53 = d53.get\\(k, \"\\(missing\\)\"\\)\n    v54 = d54.get\\(k, \"\\(missing\\)\"\\)\n    if k in sensitive:\n        v53d = \\(str\\(v53\\)[:25] + \"...\"\\) if v53 and len\\(str\\(v53\\)\\) > 0 else repr\\(v53\\)\n        v54d = \\(str\\(v54\\)[:25] + \"...\"\\) if v54 and len\\(str\\(v54\\)\\) > 0 else repr\\(v54\\)\n    else:\n        v53d = str\\(v53\\)[:42]\n        v54d = str\\(v54\\)[:42]\n    match = \"YES\" if v53 == v54 else \"NO\"\n    print\\(fmt.format\\(k, v53d, v54d, match\\)\\)\nPYEOF)",
      "Bash(python3 << 'PYEOF'\nimport json, subprocess\n\n# 先刷新账号 54 获取最新 token\nsubprocess.run\\(['curl', '-s', '-u', 'admin:admin123', 'http://localhost:3002/api/accounts/54/refresh'], capture_output=True\\)\n\n# 获取最新数据\nr = subprocess.run\\(['redis-cli', '--raw', 'GET', 'orchids:accounts:id:54'], capture_output=True, text=True\\)\nd = json.loads\\(r.stdout.strip\\(\\)\\)\n\n# 保存到文件供后续 curl 使用\nwith open\\('/tmp/test54.json', 'w'\\) as f:\n    json.dump\\({\n        'token': d['token'],\n        'client_cookie': d.get\\('client_cookie', ''\\),\n        'client_uat': d.get\\('client_uat', ''\\),\n        'user_id': d.get\\('user_id', ''\\),\n        'session_id': d.get\\('session_id', ''\\),\n    }, f\\)\n\nimport base64\nparts = d['token'].split\\('.'\\)\npayload = parts[1] + '=' * \\(4 - len\\(parts[1]\\) % 4\\)\njwt = json.loads\\(base64.urlsafe_b64decode\\(payload\\)\\)\n\nprint\\(\"=== Account 54 Current State ===\"\\)\nprint\\(\"user_id:\", d.get\\('user_id'\\)\\)\nprint\\(\"session_id:\", d.get\\('session_id'\\)\\)\nprint\\(\"client_uat:\", d.get\\('client_uat'\\)\\)\nprint\\(\"JWT iat:\", jwt.get\\('iat'\\)\\)\nprint\\(\"JWT exp:\", jwt.get\\('exp'\\)\\)\nprint\\(\"JWT sub:\", jwt.get\\('sub'\\)\\)\nprint\\(\"JWT sid:\", jwt.get\\('sid'\\)\\)\n\nimport time\nnow = int\\(time.time\\(\\)\\)\nprint\\(\"now:\", now\\)\nprint\\(\"JWT expires in:\", jwt.get\\('exp', 0\\) - now, \"seconds\"\\)\nPYEOF)",
      "Bash(python3 << 'PYEOF'\nimport json, subprocess, time\n\nwith open\\('/tmp/test54.json'\\) as f:\n    d = json.load\\(f\\)\n\ntoken = d['token']\nclient = d['client_cookie']\nuat = d['client_uat']\nuid = d['user_id']\nsid = d['session_id']\n\nimport base64\nparts = token.split\\('.'\\)\npayload = parts[1] + '=' * \\(4 - len\\(parts[1]\\) % 4\\)\njwt_data = json.loads\\(base64.urlsafe_b64decode\\(payload\\)\\)\niat = str\\(jwt_data['iat']\\)\n\nprint\\(\"=\" * 60\\)\nprint\\(\"TEST 1: 使用 hardcoded action ID + 完整 cookies\"\\)\nprint\\(\"=\" * 60\\)\n\naction_id = \"7f876a6c1a4d682f106ecd67a0f77f2aa2d035257c\"\nr = subprocess.run\\([\n    'curl', '-s', '-w', '\\\\nHTTP_STATUS:%{http_code}',\n    '-X', 'POST', 'https://www.orchids.app/',\n    '-H', 'Accept: text/x-component',\n    '-H', 'Content-Type: text/plain;charset=UTF-8',\n    '-H', 'Next-Action: ' + action_id,\n    '-H', 'Next-Router-State-Tree: [\"\",{\"children\":[\"__PAGE__\",{},null,null]},null,null,true]',\n    '-H', 'Origin: https://www.orchids.app',\n    '-H', 'Referer: https://www.orchids.app/',\n    '-H', 'User-Agent: Mozilla/5.0 \\(Macintosh; Intel Mac OS X 10_15_7\\) AppleWebKit/537.36',\n    '-b', '__session=' + token + '; __client_uat=' + iat + '; __client=' + client,\n    '-d', json.dumps\\([uid]\\),\n], capture_output=True, text=True, timeout=15\\)\nprint\\(\"Response:\", r.stdout[:500]\\)\nprint\\(\\)\n\nprint\\(\"=\" * 60\\)\nprint\\(\"TEST 2: 动态发现 action ID\"\\)\nprint\\(\"=\" * 60\\)\n\n# 获取 Orchids 首页找 script tags\nr2 = subprocess.run\\([\n    'curl', '-s', 'https://www.orchids.app/',\n    '-H', 'User-Agent: Mozilla/5.0 \\(Macintosh; Intel Mac OS X 10_15_7\\) AppleWebKit/537.36',\n], capture_output=True, text=True, timeout=15\\)\n\nimport re\nscripts = re.findall\\(r'src=\"\\(/_next/static/chunks/[^\"]+\\)\"', r2.stdout\\)\nprint\\(\"Found\", len\\(scripts\\), \"chunk scripts\"\\)\nfor s in scripts[:5]:\n    print\\(\" \", s\\)\n\nPYEOF)",
      "Bash(python3 << 'PYEOF'\nimport json, subprocess, re, time\n\nwith open\\('/tmp/test54.json'\\) as f:\n    d = json.load\\(f\\)\n\ntoken = d['token']\nclient = d['client_cookie']\nuid = d['user_id']\n\nimport base64\nparts = token.split\\('.'\\)\npayload = parts[1] + '=' * \\(4 - len\\(parts[1]\\) % 4\\)\njwt_data = json.loads\\(base64.urlsafe_b64decode\\(payload\\)\\)\niat = str\\(jwt_data['iat']\\)\n\n# 动态发现 action ID\nprint\\(\"=== 动态发现 Action ID ===\"\\)\nr = subprocess.run\\([\n    'curl', '-s', 'https://www.orchids.app/',\n    '-H', 'User-Agent: Mozilla/5.0 \\(Macintosh; Intel Mac OS X 10_15_7\\) AppleWebKit/537.36',\n], capture_output=True, text=True, timeout=15\\)\n\nscripts = re.findall\\(r'src=\"\\(/_next/static/chunks/[^\"]+\\)\"', r.stdout\\)\n\n# 搜索包含 getCredits/getUserCredits 的 chunk\naction_ids = []\nfor script_path in scripts:\n    url = \"https://www.orchids.app\" + script_path\n    r2 = subprocess.run\\([\n        'curl', '-s', url,\n        '-H', 'User-Agent: Mozilla/5.0 \\(Macintosh; Intel Mac OS X 10_15_7\\) AppleWebKit/537.36',\n    ], capture_output=True, text=True, timeout=10\\)\n    \n    # 搜索 server action pattern\n    matches = re.findall\\(r'createServerReference\\\\\\(\"\\([0-9a-f]+\\)\",\\\\s*\\\\w+,\\\\s*\"\\(\\\\w+\\)\"', r2.stdout\\)\n    for aid, name in matches:\n        if 'credit' in name.lower\\(\\) or 'user' in name.lower\\(\\):\n            action_ids.append\\(\\(aid, name, script_path.split\\('/'\\)[-1][:30]\\)\\)\n            print\\(f\"  Found: {name} -> {aid}\"\\)\n\nif not action_ids:\n    # 尝试另一种 pattern\n    for script_path in scripts:\n        url = \"https://www.orchids.app\" + script_path\n        r2 = subprocess.run\\([\n            'curl', '-s', url,\n            '-H', 'User-Agent: Mozilla/5.0',\n        ], capture_output=True, text=True, timeout=10\\)\n        matches = re.findall\\(r'\"\\([0-9a-f]{30,}\\)\"', r2.stdout\\)\n        if matches and \\('credit' in r2.stdout.lower\\(\\) or 'getUser' in r2.stdout\\):\n            for m in matches:\n                print\\(f\"  Potential action ID in {script_path.split\\('/'\\)[-1][:30]}: {m}\"\\)\n                action_ids.append\\(\\(m, \"unknown\", script_path\\)\\)\n\nprint\\(f\"\\\\nTotal found: {len\\(action_ids\\)} action IDs\"\\)\n\n# 用找到的 action ID 测试\nif action_ids:\n    for aid, name, src in action_ids[:3]:\n        print\\(f\"\\\\n=== Testing action ID: {aid} \\({name}\\) ===\"\\)\n        r3 = subprocess.run\\([\n            'curl', '-s', '-w', '\\\\nHTTP_STATUS:%{http_code}',\n            '-X', 'POST', 'https://www.orchids.app/',\n            '-H', 'Accept: text/x-component',\n            '-H', 'Content-Type: text/plain;charset=UTF-8',\n            '-H', 'Next-Action: ' + aid,\n            '-H', 'Next-Router-State-Tree: [\"\",{\"children\":[\"__PAGE__\",{},null,null]},null,null,true]',\n            '-H', 'Origin: https://www.orchids.app',\n            '-H', 'Referer: https://www.orchids.app/',\n            '-H', 'User-Agent: Mozilla/5.0 \\(Macintosh; Intel Mac OS X 10_15_7\\) AppleWebKit/537.36',\n            '-b', '__session=' + token + '; __client_uat=' + iat + '; __client=' + client,\n            '-d', json.dumps\\([uid]\\),\n        ], capture_output=True, text=True, timeout=15\\)\n        print\\(\"Response:\", r3.stdout[:500]\\)\nPYEOF)",
      "Bash(python3 << 'PYEOF'\nimport subprocess, re\n\n# 下载包含 credit 相关的 JS chunk\nurl = \"https://www.orchids.app/_next/static/chunks/827-820886facdbaddc7.js?dpl=dpl_8jtu9VRmjyJsv7BpRFSRTH3EYrCV\"\nr = subprocess.run\\([\n    'curl', '-s', url,\n    '-H', 'User-Agent: Mozilla/5.0',\n], capture_output=True, text=True, timeout=15\\)\n\njs = r.stdout\n\n# 找 createServerReference 调用，提取 action ID 和函数名\npattern = r'createServerReference\\\\\\(\\\\s*\"\\([0-9a-f]+\\)\"\\\\s*,\\\\s*\\\\w+\\\\s*,\\\\s*\"\\(\\\\w+\\)\"'\nmatches = re.findall\\(pattern, js\\)\nif matches:\n    print\\(\"=== createServerReference calls in 827 chunk ===\"\\)\n    for aid, name in matches:\n        marker = \"<<<\" if \"credit\" in name.lower\\(\\) else \"\"\n        print\\(f\"  {name:<40} -> {aid} {marker}\"\\)\nelse:\n    # 尝试更宽松的 pattern\n    # 搜索 action ID 附近的上下文\n    for aid in [\"7f876a6c1a4d682f106ecd67a0f77f2aa2d035257c\"]:\n        idx = js.find\\(aid\\)\n        if idx >= 0:\n            context = js[max\\(0, idx-200\\):idx+200]\n            print\\(f\"Context around {aid}:\"\\)\n            print\\(context\\)\n            print\\(\\)\n\n# 也搜索 \"credit\" 关键词附近\nfor m in re.finditer\\(r'[Cc]redit', js\\):\n    start = max\\(0, m.start\\(\\) - 100\\)\n    end = min\\(len\\(js\\), m.end\\(\\) + 100\\)\n    snippet = js[start:end]\n    if '7f' in snippet:\n        print\\(f\"\\\\n--- credit context at pos {m.start\\(\\)} ---\"\\)\n        print\\(snippet\\)\nPYEOF)",
      "Bash(python3 << 'PYEOF'\nimport subprocess, re\n\nurl = \"https://www.orchids.app/_next/static/chunks/827-820886facdbaddc7.js?dpl=dpl_8jtu9VRmjyJsv7BpRFSRTH3EYrCV\"\nr = subprocess.run\\(['curl', '-s', url, '-H', 'User-Agent: Mozilla/5.0'], capture_output=True, text=True, timeout=15\\)\njs = r.stdout\n\n# 提取所有 createServerReference\npattern = r'createServerReference\\\\\\(\\\\s*\"\\([0-9a-f]+\\)\"\\\\s*,\\\\s*\\\\w+\\\\.callServer\\\\s*,\\\\s*void\\\\s+0\\\\s*,\\\\s*\\\\w+\\\\.findSourceMapURL\\\\s*,\\\\s*\"\\(\\\\w+\\)\"\\\\s*\\\\\\)'\nmatches = re.findall\\(pattern, js\\)\n\nprint\\(\"=== All Server Actions in 827 chunk ===\"\\)\nfor aid, name in matches:\n    print\\(f\"  {name:<35} -> {aid}\"\\)\n\n# 也搜索其他 chunk\nfor chunk_url in [\n    \"https://www.orchids.app/_next/static/chunks/1334-e4ac7ee55d2746b5.js?dpl=dpl_8jtu9VRmjyJsv7BpRFSRTH3EYrCV\",\n]:\n    r2 = subprocess.run\\(['curl', '-s', chunk_url, '-H', 'User-Agent: Mozilla/5.0'], capture_output=True, text=True, timeout=15\\)\n    matches2 = re.findall\\(pattern, r2.stdout\\)\n    if matches2:\n        print\\(f\"\\\\n=== Server Actions in 1334 chunk ===\"\\)\n        for aid, name in matches2:\n            print\\(f\"  {name:<35} -> {aid}\"\\)\nPYEOF)",
      "Bash(python3 << 'PYEOF'\nimport subprocess, re\n\nurl = \"https://www.orchids.app/_next/static/chunks/827-820886facdbaddc7.js?dpl=dpl_8jtu9VRmjyJsv7BpRFSRTH3EYrCV\"\nr = subprocess.run\\(['curl', '-s', url, '-H', 'User-Agent: Mozilla/5.0'], capture_output=True, text=True, timeout=15\\)\njs = r.stdout\n\n# 更宽松的 pattern - 找 action ID 后面跟着的函数名\npattern = r'\"\\(7f[0-9a-f]{38,42}\\)\".*?\"\\(\\\\w+\\)\"\\\\\\)'\n# 逐段搜索\nsegments = js.split\\('createServerReference'\\)\nprint\\(f\"Found {len\\(segments\\)-1} createServerReference calls\\\\n\"\\)\n\nfor i, seg in enumerate\\(segments[1:], 1\\):\n    # 提取 action ID 和函数名\n    m = re.search\\(r'\"\\(7f[0-9a-f]{30,}\\)\"', seg[:200]\\)\n    n = re.findall\\(r'\"\\(\\\\w+\\)\"\\\\\\)', seg[:300]\\)\n    if m:\n        aid = m.group\\(1\\)\n        name = n[-1] if n else \"?\"\n        marker = \" <<<\" if aid == \"7f876a6c1a4d682f106ecd67a0f77f2aa2d035257c\" else \"\"\n        print\\(f\"  {i}: {name:<40} -> {aid}{marker}\"\\)\nPYEOF)",
      "Bash(python3 << 'PYEOF'\nimport json, subprocess, base64\n\n# 先刷新获取新 token\nsubprocess.run\\(['curl', '-s', '-u', 'admin:admin123', 'http://localhost:3002/api/accounts/54/refresh'], capture_output=True\\)\n\nr = subprocess.run\\(['redis-cli', '--raw', 'GET', 'orchids:accounts:id:54'], capture_output=True, text=True\\)\nd = json.loads\\(r.stdout.strip\\(\\)\\)\ntoken = d['token']\nclient = d['client_cookie']\nuid = d['user_id']\n\nparts = token.split\\('.'\\)\npayload = parts[1] + '=' * \\(4 - len\\(parts[1]\\) % 4\\)\njwt_data = json.loads\\(base64.urlsafe_b64decode\\(payload\\)\\)\niat = str\\(jwt_data['iat']\\)\n\nactions = {\n    \"getUserProfile\": \"7f876a6c1a4d682f106ecd67a0f77f2aa2d035257c\",\n    \"checkAndResetPaidCredits\": \"7f6a74200e7b06c443c378c04013129dc7ed00faae\",\n    \"claimOpusFourSixFreeCredits\": \"7f419d863da80fc068a45050ff80853b35b7a50576\",\n    \"redeemFreeCredits\": \"7fc4860ef6338712bcbc112fe7d34db055a4fb20cb\",\n}\n\nfor name, aid in actions.items\\(\\):\n    r2 = subprocess.run\\([\n        'curl', '-s', '-w', '\\\\nHTTP:%{http_code}',\n        '-X', 'POST', 'https://www.orchids.app/',\n        '-H', 'Accept: text/x-component',\n        '-H', 'Content-Type: text/plain;charset=UTF-8',\n        '-H', 'Next-Action: ' + aid,\n        '-H', 'Next-Router-State-Tree: [\"\",{\"children\":[\"__PAGE__\",{},null,null]},null,null,true]',\n        '-H', 'Origin: https://www.orchids.app',\n        '-H', 'Referer: https://www.orchids.app/',\n        '-H', 'User-Agent: Mozilla/5.0 \\(Macintosh; Intel Mac OS X 10_15_7\\) AppleWebKit/537.36',\n        '-b', '__session=' + token + '; __client_uat=' + iat + '; __client=' + client,\n        '-d', json.dumps\\([uid]\\),\n    ], capture_output=True, text=True, timeout=15\\)\n    \n    lines = r2.stdout.strip\\(\\).split\\('\\\\n'\\)\n    http_line = [l for l in lines if l.startswith\\('HTTP:'\\)]\n    status = http_line[0] if http_line else '?'\n    body = '\\\\n'.join\\(l for l in lines if not l.startswith\\('HTTP:'\\)\\)\n    \n    print\\(f\"=== {name} ===\"\\)\n    print\\(f\"  Status: {status}\"\\)\n    print\\(f\"  Body: {body[:300]}\"\\)\n    print\\(\\)\n\nPYEOF)",
      "Bash(python3 << 'PYEOF'\nimport json, subprocess, base64\n\n# 刷新 token\nsubprocess.run\\(['curl', '-s', '-u', 'admin:admin123', 'http://localhost:3002/api/accounts/54/refresh'], capture_output=True\\)\n\nr = subprocess.run\\(['redis-cli', '--raw', 'GET', 'orchids:accounts:id:54'], capture_output=True, text=True\\)\nd = json.loads\\(r.stdout.strip\\(\\)\\)\ntoken = d['token']\nclient = d['client_cookie']\nuid = d['user_id']\n\nparts = token.split\\('.'\\)\npayload = parts[1] + '=' * \\(4 - len\\(parts[1]\\) % 4\\)\njwt_data = json.loads\\(base64.urlsafe_b64decode\\(payload\\)\\)\niat = str\\(jwt_data['iat']\\)\n\n# 再次测试 getUserProfile\nr2 = subprocess.run\\([\n    'curl', '-s', '-w', '\\\\nHTTP:%{http_code}',\n    '-X', 'POST', 'https://www.orchids.app/',\n    '-H', 'Accept: text/x-component',\n    '-H', 'Content-Type: text/plain;charset=UTF-8',\n    '-H', 'Next-Action: 7f876a6c1a4d682f106ecd67a0f77f2aa2d035257c',\n    '-H', 'Next-Router-State-Tree: [\"\",{\"children\":[\"__PAGE__\",{},null,null]},null,null,true]',\n    '-H', 'Origin: https://www.orchids.app',\n    '-H', 'Referer: https://www.orchids.app/',\n    '-H', 'User-Agent: Mozilla/5.0 \\(Macintosh; Intel Mac OS X 10_15_7\\) AppleWebKit/537.36',\n    '-b', '__session=' + token + '; __client_uat=' + iat + '; __client=' + client,\n    '-d', json.dumps\\([uid]\\),\n], capture_output=True, text=True, timeout=15\\)\n\nprint\\(\"=== getUserProfile after claiming credits ===\"\\)\nprint\\(r2.stdout[:600]\\)\nPYEOF)",
      "Bash(python3 << 'PYEOF'\nimport subprocess, re\n\n# 检查 1334 和 3966 chunk 的 server actions\nchunks = [\n    \"https://www.orchids.app/_next/static/chunks/1334-e4ac7ee55d2746b5.js?dpl=dpl_8jtu9VRmjyJsv7BpRFSRTH3EYrCV\",\n    \"https://www.orchids.app/_next/static/chunks/3966-6187363bace25c6d.js?dpl=dpl_8jtu9VRmjyJsv7BpRFSRTH3EYrCV\",\n    \"https://www.orchids.app/_next/static/chunks/6777-e1544d89c9e5b032.js?dpl=dpl_8jtu9VRmjyJsv7BpRFSRTH3EYrCV\",\n    \"https://www.orchids.app/_next/static/chunks/layout-572b562a525c35e4.js?dpl=dpl_8jtu9VRmjyJsv7BpRFSRTH3EYrCV\",\n]\n\nfor url in chunks:\n    name = url.split\\('/'\\)[-1].split\\('?'\\)[0]\n    r = subprocess.run\\(['curl', '-s', url, '-H', 'User-Agent: Mozilla/5.0'], capture_output=True, text=True, timeout=15\\)\n    js = r.stdout\n    \n    segments = js.split\\('createServerReference'\\)\n    if len\\(segments\\) <= 1:\n        continue\n    \n    print\\(f\"=== {name} \\({len\\(segments\\)-1} actions\\) ===\"\\)\n    for i, seg in enumerate\\(segments[1:], 1\\):\n        m = re.search\\(r'\"\\(7f[0-9a-f]{30,}\\)\"', seg[:200]\\)\n        if not m:\n            m = re.search\\(r'\"\\([0-9a-f]{30,}\\)\"', seg[:200]\\)\n        names = re.findall\\(r'\"\\(\\\\w+\\)\"\\\\\\)', seg[:300]\\)\n        if m:\n            aid = m.group\\(1\\)\n            fname = names[-1] if names else \"?\"\n            print\\(f\"  {fname:<40} -> {aid}\"\\)\n    print\\(\\)\nPYEOF)",
      "Bash(python3 << 'PYEOF'\nimport subprocess\n\n# 下载包含 getUserProfile 调用的 JS chunk，看前端怎么调用它\nurl = \"https://www.orchids.app/_next/static/chunks/827-820886facdbaddc7.js?dpl=dpl_8jtu9VRmjyJsv7BpRFSRTH3EYrCV\"\nr = subprocess.run\\(['curl', '-s', url, '-H', 'User-Agent: Mozilla/5.0'], capture_output=True, text=True, timeout=15\\)\njs = r.stdout\n\n# 找 getUserProfile 被调用的上下文\nidx = js.find\\('getUserProfile'\\)\nif idx >= 0:\n    # 找到定义位置\n    print\\(\"=== getUserProfile 定义上下文 ===\"\\)\n    print\\(js[max\\(0,idx-200\\):idx+300]\\)\n    print\\(\\)\n\n# 搜索变量 l \\(getUserProfile 赋值给了 l\\) 被调用的地方\n# 从之前的分析: let l = createServerReference\\(\"7f876a...\", ..., \"getUserProfile\"\\)\n# 找 l\\( 的调用\nimport re\n# 找到 getUserProfile 赋值的变量名\nm = re.search\\(r'let\\\\s+\\(\\\\w+\\)\\\\s*=\\\\s*\\\\\\(0,\\\\w+\\\\.createServerReference\\\\\\)\\\\\\(\"7f876a6c1a4d682f106ecd67a0f77f2aa2d035257c\"', js\\)\nif m:\n    var_name = m.group\\(1\\)\n    print\\(f\"getUserProfile 赋值给变量: {var_name}\"\\)\n    \n    # 搜索该变量被调用的地方\n    pattern = var_name + r'\\\\\\('\n    for match in re.finditer\\(pattern, js\\):\n        start = max\\(0, match.start\\(\\) - 50\\)\n        end = min\\(len\\(js\\), match.end\\(\\) + 150\\)\n        snippet = js[start:end]\n        if 'createServerReference' not in snippet:\n            print\\(f\"\\\\n--- 调用位置 {match.start\\(\\)} ---\"\\)\n            print\\(snippet\\)\nPYEOF)",
      "Bash(python3 << 'PYEOF'\nimport subprocess\n\nurl = \"https://www.orchids.app/_next/static/chunks/827-820886facdbaddc7.js?dpl=dpl_8jtu9VRmjyJsv7BpRFSRTH3EYrCV\"\nr = subprocess.run\\(['curl', '-s', url, '-H', 'User-Agent: Mozilla/5.0'], capture_output=True, text=True, timeout=15\\)\njs = r.stdout\n\n# 找 52351 附近的上下文，看 m 是什么\nidx = js.find\\('\"/api/users/\".concat\\(m\\)'\\)\nif idx >= 0:\n    # 往前找 m 的来源\n    context = js[max\\(0, idx-500\\):idx+500]\n    print\\(\"=== getUserProfile 调用上下文 ===\"\\)\n    print\\(context\\)\nPYEOF)",
      "Bash(python3 << 'PYEOF'\nimport subprocess, json, base64\n\n# 刷新 token\nsubprocess.run\\(['curl', '-s', '-u', 'admin:admin123', 'http://localhost:3002/api/accounts/54/refresh'], capture_output=True\\)\n\nr = subprocess.run\\(['redis-cli', '--raw', 'GET', 'orchids:accounts:id:54'], capture_output=True, text=True\\)\nd = json.loads\\(r.stdout.strip\\(\\)\\)\ntoken = d['token']\nclient_cookie = d.get\\('client_cookie', ''\\)\nuser_id = d.get\\('user_id', ''\\)\n\nparts = token.split\\('.'\\)\npayload = parts[1] + '=' * \\(4 - len\\(parts[1]\\) % 4\\)\njwt_data = json.loads\\(base64.urlsafe_b64decode\\(payload\\)\\)\niat = str\\(jwt_data['iat']\\)\n\nprint\\(\"=== 我们发送的请求参数 ===\"\\)\nprint\\(\"POST body:\", json.dumps\\([user_id]\\)\\)\nprint\\(\"Action ID: 7f876a6c1a4d682f106ecd67a0f77f2aa2d035257c\"\\)\nprint\\(\\)\nprint\\(\"Cookies:\"\\)\nprint\\(\"  __session:\", token[:50] + \"...\"\\)\nprint\\(\"  __client_uat:\", iat\\)\nprint\\(\"  __client:\", client_cookie[:50] + \"...\"\\)\nprint\\(\\)\n\n# 测试 1: 不传 user_id，看看 server action 是否自己从 session 获取\nprint\\(\"=== TEST: 不传 userId 参数 ===\"\\)\nr2 = subprocess.run\\([\n    'curl', '-s', '-w', '\\\\nHTTP:%{http_code}', '--max-time', '10',\n    '-X', 'POST', 'https://www.orchids.app/',\n    '-H', 'Accept: text/x-component',\n    '-H', 'Content-Type: text/plain;charset=UTF-8',\n    '-H', 'Next-Action: 7f876a6c1a4d682f106ecd67a0f77f2aa2d035257c',\n    '-H', 'Next-Router-State-Tree: [\"\",{\"children\":[\"__PAGE__\",{},null,null]},null,null,true]',\n    '-H', 'Origin: https://www.orchids.app',\n    '-H', 'Referer: https://www.orchids.app/',\n    '-H', 'User-Agent: Mozilla/5.0 \\(Macintosh; Intel Mac OS X 10_15_7\\) AppleWebKit/537.36',\n    '-b', '__session=' + token + '; __client_uat=' + iat + '; __client=' + client_cookie,\n    '-d', '[]',\n], capture_output=True, text=True, timeout=15\\)\nprint\\(\"Response:\", r2.stdout[:300]\\)\nprint\\(\\)\n\n# 测试 2: 用账号 53 的 user_id 但账号 54 的 session（看是否是 user_id 的问题）\nr53 = subprocess.run\\(['redis-cli', '--raw', 'GET', 'orchids:accounts:id:53'], capture_output=True, text=True\\)\nd53 = json.loads\\(r53.stdout.strip\\(\\)\\)\nuid53 = d53.get\\('user_id', ''\\)\n\nprint\\(\"=== TEST: 用账号 53 的 userId + 账号 54 的 session ===\"\\)\nr3 = subprocess.run\\([\n    'curl', '-s', '-w', '\\\\nHTTP:%{http_code}', '--max-time', '10',\n    '-X', 'POST', 'https://www.orchids.app/',\n    '-H', 'Accept: text/x-component',\n    '-H', 'Content-Type: text/plain;charset=UTF-8',\n    '-H', 'Next-Action: 7f876a6c1a4d682f106ecd67a0f77f2aa2d035257c',\n    '-H', 'Next-Router-State-Tree: [\"\",{\"children\":[\"__PAGE__\",{},null,null]},null,null,true]',\n    '-H', 'Origin: https://www.orchids.app',\n    '-H', 'Referer: https://www.orchids.app/',\n    '-H', 'User-Agent: Mozilla/5.0 \\(Macintosh; Intel Mac OS X 10_15_7\\) AppleWebKit/537.36',\n    '-b', '__session=' + token + '; __client_uat=' + iat + '; __client=' + client_cookie,\n    '-d', json.dumps\\([uid53]\\),\n], capture_output=True, text=True, timeout=15\\)\nprint\\(\"Response:\", r3.stdout[:300]\\)\nprint\\(\\)\n\n# 测试 3: 完全不带 __client cookie\nprint\\(\"=== TEST: 不带 __client cookie ===\"\\)\nr4 = subprocess.run\\([\n    'curl', '-s', '-w', '\\\\nHTTP:%{http_code}', '--max-time', '10',\n    '-X', 'POST', 'https://www.orchids.app/',\n    '-H', 'Accept: text/x-component',\n    '-H', 'Content-Type: text/plain;charset=UTF-8',\n    '-H', 'Next-Action: 7f876a6c1a4d682f106ecd67a0f77f2aa2d035257c',\n    '-H', 'Next-Router-State-Tree: [\"\",{\"children\":[\"__PAGE__\",{},null,null]},null,null,true]',\n    '-H', 'Origin: https://www.orchids.app',\n    '-H', 'Referer: https://www.orchids.app/',\n    '-H', 'User-Agent: Mozilla/5.0 \\(Macintosh; Intel Mac OS X 10_15_7\\) AppleWebKit/537.36',\n    '-b', '__session=' + token + '; __client_uat=' + iat,\n    '-d', json.dumps\\([user_id]\\),\n], capture_output=True, text=True, timeout=15\\)\nprint\\(\"Response:\", r4.stdout[:300]\\)\n\nPYEOF)",
      "Bash(python3 << 'PYEOF'\nimport subprocess, json, base64\n\n# 刷新两个账号\nsubprocess.run\\(['curl', '-s', '-u', 'admin:admin123', 'http://localhost:3002/api/accounts/53/refresh'], capture_output=True\\)\nsubprocess.run\\(['curl', '-s', '-u', 'admin:admin123', 'http://localhost:3002/api/accounts/54/refresh'], capture_output=True\\)\n\nr53 = subprocess.run\\(['redis-cli', '--raw', 'GET', 'orchids:accounts:id:53'], capture_output=True, text=True\\)\nr54 = subprocess.run\\(['redis-cli', '--raw', 'GET', 'orchids:accounts:id:54'], capture_output=True, text=True\\)\nd53 = json.loads\\(r53.stdout.strip\\(\\)\\)\nd54 = json.loads\\(r54.stdout.strip\\(\\)\\)\n\ntoken53 = d53['token']\nclient53 = d53.get\\('client_cookie', ''\\)\nuid53 = d53.get\\('user_id', ''\\)\nparts53 = token53.split\\('.'\\)\niat53 = str\\(json.loads\\(base64.urlsafe_b64decode\\(parts53[1] + '=' * \\(4 - len\\(parts53[1]\\) % 4\\)\\)\\)['iat']\\)\n\ntoken54 = d54['token']\nclient54 = d54.get\\('client_cookie', ''\\)\nuid54 = d54.get\\('user_id', ''\\)\nparts54 = token54.split\\('.'\\)\niat54 = str\\(json.loads\\(base64.urlsafe_b64decode\\(parts54[1] + '=' * \\(4 - len\\(parts54[1]\\) % 4\\)\\)\\)['iat']\\)\n\n# TEST 1: 用账号 53 的 session 查询账号 54 的 userId\nprint\\(\"=== TEST 1: 账号 53 session + 账号 54 userId ===\"\\)\nr = subprocess.run\\([\n    'curl', '-s', '-w', '\\\\nHTTP:%{http_code}', '--max-time', '10',\n    '-X', 'POST', 'https://www.orchids.app/',\n    '-H', 'Accept: text/x-component',\n    '-H', 'Content-Type: text/plain;charset=UTF-8',\n    '-H', 'Next-Action: 7f876a6c1a4d682f106ecd67a0f77f2aa2d035257c',\n    '-H', 'Next-Router-State-Tree: [\"\",{\"children\":[\"__PAGE__\",{},null,null]},null,null,true]',\n    '-H', 'Origin: https://www.orchids.app',\n    '-H', 'Referer: https://www.orchids.app/',\n    '-H', 'User-Agent: Mozilla/5.0 \\(Macintosh; Intel Mac OS X 10_15_7\\) AppleWebKit/537.36',\n    '-b', '__session=' + token53 + '; __client_uat=' + iat53 + '; __client=' + client53,\n    '-d', json.dumps\\([uid54]\\),\n], capture_output=True, text=True, timeout=15\\)\nprint\\(r.stdout[:500]\\)\nprint\\(\\)\n\n# TEST 2: 用 addUserCredits 看看能否触发用户创建\nprint\\(\"=== TEST 2: addUserCredits \\(账号 54 session\\) ===\"\\)\nr2 = subprocess.run\\([\n    'curl', '-s', '-w', '\\\\nHTTP:%{http_code}', '--max-time', '10',\n    '-X', 'POST', 'https://www.orchids.app/',\n    '-H', 'Accept: text/x-component',\n    '-H', 'Content-Type: text/plain;charset=UTF-8',\n    '-H', 'Next-Action: 7fbceedd74f1c7b6914cfc5996ebf29ace1c66a789',\n    '-H', 'Next-Router-State-Tree: [\"\",{\"children\":[\"__PAGE__\",{},null,null]},null,null,true]',\n    '-H', 'Origin: https://www.orchids.app',\n    '-H', 'Referer: https://www.orchids.app/',\n    '-H', 'User-Agent: Mozilla/5.0 \\(Macintosh; Intel Mac OS X 10_15_7\\) AppleWebKit/537.36',\n    '-b', '__session=' + token54 + '; __client_uat=' + iat54 + '; __client=' + client54,\n    '-d', json.dumps\\([uid54, 0]\\),\n], capture_output=True, text=True, timeout=15\\)\nprint\\(r2.stdout[:500]\\)\nprint\\(\\)\n\n# TEST 3: 再次尝试 getUserProfile（可能 claimCredits 已经创建了记录）\nprint\\(\"=== TEST 3: getUserProfile 再试 \\(账号 54\\) ===\"\\)\n# 先重新刷新 token\nsubprocess.run\\(['curl', '-s', '-u', 'admin:admin123', 'http://localhost:3002/api/accounts/54/refresh'], capture_output=True\\)\nr54b = subprocess.run\\(['redis-cli', '--raw', 'GET', 'orchids:accounts:id:54'], capture_output=True, text=True\\)\nd54b = json.loads\\(r54b.stdout.strip\\(\\)\\)\ntoken54b = d54b['token']\nparts54b = token54b.split\\('.'\\)\niat54b = str\\(json.loads\\(base64.urlsafe_b64decode\\(parts54b[1] + '=' * \\(4 - len\\(parts54b[1]\\) % 4\\)\\)\\)['iat']\\)\n\nr3 = subprocess.run\\([\n    'curl', '-s', '-w', '\\\\nHTTP:%{http_code}', '--max-time', '10',\n    '-X', 'POST', 'https://www.orchids.app/',\n    '-H', 'Accept: text/x-component',\n    '-H', 'Content-Type: text/plain;charset=UTF-8',\n    '-H', 'Next-Action: 7f876a6c1a4d682f106ecd67a0f77f2aa2d035257c',\n    '-H', 'Next-Router-State-Tree: [\"\",{\"children\":[\"__PAGE__\",{},null,null]},null,null,true]',\n    '-H', 'Origin: https://www.orchids.app',\n    '-H', 'Referer: https://www.orchids.app/',\n    '-H', 'User-Agent: Mozilla/5.0 \\(Macintosh; Intel Mac OS X 10_15_7\\) AppleWebKit/537.36',\n    '-b', '__session=' + token54b + '; __client_uat=' + iat54b + '; __client=' + d54b.get\\('client_cookie',''\\),\n    '-d', json.dumps\\([uid54]\\),\n], capture_output=True, text=True, timeout=15\\)\nprint\\(r3.stdout[:500]\\)\n\nPYEOF)",
      "Bash(redis-cli -p 6379 GET \"orchids:account:53\")",
      "Bash(redis-cli -p 6379 KEYS \"orchids:*account*\")",
      "Bash(redis-cli -p 6379 GET \"orchids:accounts:id:53\")",
      "Bash(go build ./...)",
      "Bash(go test ./...)",
      "Bash(redis-cli -n 0 keys \"orchids:account:*\")",
      "Bash(redis-cli -n 0 keys \"*\")",
      "Bash(redis-cli -n 0 get \"orchids:accounts:id:53\")",
      "Bash(redis-cli -n 0 smembers \"orchids:accounts:ids\")",
      "Bash(redis-cli -n 0 smembers \"orchids:accounts:enabled\")",
      "Bash(python3 -c \"\nimport sys, json\ndata = json.load\\(sys.stdin\\)\nprint\\(''status_code:'', repr\\(data.get\\(''status_code''\\)\\)\\)\nprint\\(''last_attempt:'', data.get\\(''last_attempt''\\)\\)\nprint\\(''token exp check...''\\)\n# decode JWT to check expiry\nimport base64\ntoken = data.get\\(''token'',''''\\)\nparts = token.split\\(''.''\\)\nif len\\(parts\\) >= 2:\n    payload = parts[1] + ''==''\n    decoded = base64.urlsafe_b64decode\\(payload\\)\n    payload_data = json.loads\\(decoded\\)\n    print\\(''token exp:'', payload_data.get\\(''exp''\\)\\)\n    print\\(''token iat:'', payload_data.get\\(''iat''\\)\\)\n    print\\(''token sts:'', payload_data.get\\(''sts''\\)\\)\n\")",
      "Bash(python3 -c \"\nimport time\nexp = 1770517708\nnow = int\\(time.time\\(\\)\\)\nprint\\(f''Token exp timestamp: {exp}''\\)\nprint\\(f''Current timestamp:   {now}''\\)\nprint\\(f''Difference \\(seconds\\): {exp - now}''\\)\nif now > exp:\n    print\\(f''Token EXPIRED {now - exp} seconds ago \\({\\(now - exp\\)/60:.1f} minutes\\)''\\)\nelse:\n    print\\(f''Token valid for {exp - now} seconds \\({\\(exp - now\\)/60:.1f} minutes\\)''\\)\n\")",
      "Bash(python3 -c \"\nimport sys, json\ndata = json.load\\(sys.stdin\\)\ndata[''status_code''] = ''''\ndata[''last_attempt''] = ''0001-01-01T00:00:00Z''\nprint\\(json.dumps\\(data\\)\\)\n\")",
      "Bash(redis-cli -n 0 -x set \"orchids:accounts:id:53\")",
      "Bash(go vet ./...)",
      "Bash(redis-cli KEYS \"orchids:*\")",
      "Bash(redis-cli SMEMBERS \"orchids:accounts:ids\")",
      "Bash(redis-cli SMEMBERS \"orchids:accounts:enabled\")",
      "Bash(redis-cli GET \"orchids:settings:config\")",
      "Bash(python3 -m json.tool)",
      "Bash(python3 -c \"\nimport sys, json\nconfig = json.load\\(sys.stdin\\)\n# 清除残留的账号相关字段\nconfig[''session_id''] = ''''\nconfig[''client_cookie''] = ''''\nconfig[''session_cookie''] = ''''\nconfig[''client_uat''] = ''''\nconfig[''user_id''] = ''''\nconfig[''email''] = ''''\nprint\\(json.dumps\\(config\\)\\)\n\")",
      "Bash(redis-cli -x SET \"orchids:settings:config\")",
      "Bash(python3 -c \"\nimport sys, json\nconfig = json.load\\(sys.stdin\\)\nfields = [''session_id'', ''client_cookie'', ''session_cookie'', ''client_uat'', ''user_id'', ''email'']\nfor f in fields:\n    print\\(f''{f}: \"\"{config.get\\(f, \"\"\"\"\\)}\"\"''\\)\n\")",
      "Bash(go install:*)",
      "Bash(go build:*)",
      "Bash(golangci-lint:*)",
      "Bash(/Users/dailin/go/bin/staticcheck ./...)",
      "Bash(go test ./internal/warp/... ./internal/handler/... -v -count=1)",
      "Bash(go test ./internal/handler/... ./internal/warp/... -v -count=1)"
    ]
  }
}
