# System Debugging & Protocol Compliance Report (2026-01-31)

This document summarizes the critical issues identified and resolved during the debugging session focused on load balancing and Anthropic SSE protocol compliance.

## 1. Load Balancing: Sticky Account Selection
- **Issue**: Requests were consistently routed to the same account regardless of load, even when multiple accounts were idle.
- **Root Cause**: The load balancer sorted accounts by ID and chose the first one in case of a tied score. Since all idle accounts had a score of 0, the first account (lowest ID) always received the traffic.
- **Fix**: Implemented random selection among all accounts sharing the minimum load score.
- **Location**: `internal/loadbalancer/loadbalancer.go`

## 2. SSE Block Mismatch: Content Sequence
- **Issue**: Clients reported "Mismatched content block type: thinking".
- **Root Cause**: The server would sometimes send a `thinking` delta or start a new block without closing the previous one, violating the strict Anthropic block sequence (start -> delta -> stop).
- **Fix**: Introduced `ensureBlock(type)` and `closeActiveBlock()` helpers in the stream handler. This ensures a block is explicitly closed (sending `content_block_stop`) before a new one is opened.
- **Location**: `internal/handler/stream_handler.go`

## 3. Persistent Mismatch: Turn-based State Leakage & Index Reset
- **Issue**: The block mismatch error persisted specifically during multi-turn tool calls and connection retries.
- **Root Cause**: 
    1. `resetRoundState()` incorrectly reset `blockIndex` to -1. On retries or multi-turns, this caused the server to reuse index 0, contradicting the client's cached state.
    2. The retry loop in `handler.go` failed to call `resetRoundState()`, leaving `activeBlockType` stale and triggering a delta without a preceding start event.
- **Fix**: 
    1. Updated `resetRoundState()` to preserve `blockIndex` across turns/retries, ensuring monotonic index growth.
    2. Added explicit `sh.resetRoundState()` calls in the `handler.go` retry loop.
    3. Shortened `orchidsWSConnectTimeout` to 10s to trigger retries faster than browser/client timeouts.
- **Location**: `internal/handler/stream_handler.go`, `internal/handler/handler.go`, `internal/client/orchids_ws_shared.go`

## 4. Protocol Compliance Enhancements
- **JSON Error Responses**: Replaced plain-text 4xx/5xx errors with Anthropic-compliant JSON structures (`{"type": "error", "error": {...}}`).
- **Non-Stream Thinking**: Added logic to collect reasoning deltas into builders during non-streaming requests, ensuring the final response remains structured.
- **Model Mapping**: Refactored the internal model translation to support more specific versions like `sonnet-3.5` and `haiku-3.5`.

---
*Report Generated by Antigravity AI*
